@model FirstWebApplication1.Models.ObstacleData

@{
    ViewData["Title"] = "Obstacle Details";
}

<body class="bg-cover bg-center" style="background-image: url('/images/BackgroundImageGreen.png');">
    @Html.AntiForgeryToken()
    <section class="mx-auto max-w-4xl mt-8">
        <div class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 p-8">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">@Model.ObstacleName</h1>
                    <p class="text-gray-600 mt-2">Obstacle details and information</p>
                </div>
                <div class="flex space-x-3">
                    <a asp-action="Edit" asp-route-id="@Model.Id"
                       class="inline-flex items-center rounded-lg bg-white px-4 py-2 text-sm font-medium text-gray-700 ring-1 ring-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Edit
                    </a>
                    <a asp-action="List"
                       class="inline-flex items-center rounded-lg bg-white px-4 py-2 text-sm font-medium text-gray-700 ring-1 ring-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Back to List
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h3>
                        <dl class="grid grid-cols-1 gap-4">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Obstacle Name</dt>
                                <dd class="mt-1 text-sm text-gray-900">@Model.ObstacleName</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Height</dt>
                                <dd class="mt-1 text-sm text-gray-900">@Model.ObstacleHeight meters</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Description</dt>
                                <dd class="mt-1 text-sm text-gray-900">@Model.ObstacleDescription</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Status</dt>
                                <dd class="mt-1">
                                    @{
                                        var statusClass = Model.Status switch
                                        {
                                            "Approved" => "bg-green-100 text-green-800",
                                            "Rejected" => "bg-red-100 text-red-800",
                                            _ => "bg-yellow-100 text-yellow-800"
                                        };
                                    }
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @statusClass">
                                        @Model.Status
                                    </span>
                                </dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Submitted By</dt>
                                <dd class="mt-1 text-sm text-gray-900">@Model.SubmittedBy</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Submitted Date</dt>
                                <dd class="mt-1 text-sm text-gray-900">@Model.SubmittedDate.ToString("MMM dd, yyyy HH:mm")</dd>
                            </div>
                        </dl>
                    </div>

                    @if (User.IsInRole("Registerfører") || User.IsInRole("Admin"))
                    {
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Approval Actions</h3>
                            <div class="flex space-x-3">
                                <form asp-action="Approve" asp-route-id="@Model.Id" method="post" class="inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit"
                                            class="inline-flex items-center rounded-lg bg-green-600 px-4 py-2 text-sm font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        Approve
                                    </button>
                                </form>
                                <button type="button" onclick="showRejectModal()"
                                        class="inline-flex items-center rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    Reject
                                </button>
                                <button type="button" onclick="deleteObstacle(@Model.Id)"
                                        class="inline-flex items-center rounded-lg bg-gray-800 px-4 py-2 text-sm font-medium text-white hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                    Delete
                                </button>
                            </div>
                        </div>
                    }
                </div>

                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Location</h3>
                    <div id="map" class="rounded-lg border border-gray-200" style="height: 300px;"></div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Latitude</dt>
                            <dd class="mt-1 text-sm text-gray-900">@Model.Latitude</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Longitude</dt>
                            <dd class="mt-1 text-sm text-gray-900">@Model.Longitude</dd>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</body>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([@Model.Latitude, @Model.Longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        L.marker([@Model.Latitude, @Model.Longitude])
            .addTo(map)
            .bindPopup('@Model.ObstacleName')
            .openPopup();

        // Get anti-forgery token
        function getAntiForgeryToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
        }

        function showRejectModal() {
            const reason = prompt('Please enter a reason for rejection (optional):');
            if (reason !== null) {
                rejectObstacle(@Model.Id, reason);
            }
        }

        async function rejectObstacle(id, reason) {
            try {
                const response = await fetch(`/api/reports/${id}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({ declineReason: reason })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Obstacle rejected successfully');
                    location.reload();
                } else {
                    alert('Failed to reject obstacle: ' + data.message);
                }
            } catch (error) {
                alert('Error rejecting obstacle: ' + error.message);
            }
        }

        async function deleteObstacle(id) {
            if (!confirm('Are you sure you want to delete this obstacle? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/reports/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'RequestVerificationToken': getAntiForgeryToken()
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Obstacle deleted successfully');
                    window.location.href = '/Obstacle/List';
                } else {
                    alert('Failed to delete obstacle: ' + data.message);
                }
            } catch (error) {
                alert('Error deleting obstacle: ' + error.message);
            }
        }
    </script>
}